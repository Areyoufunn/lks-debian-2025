# Service 03: Certificate Authority (int-srv)

> **VM:** int-srv  
> **Role:** Root CA & Certificate Generation  
> **Directory:** `/etc/ssl/lksn-ca/`

## ðŸ“‹ Overview

Certificate Authority (CA) menyediakan SSL/TLS certificates untuk semua services yang memerlukan encryption (HTTPS, LDAPS, SMTPS, IMAPS, VPN).

## ðŸ”§ Setup Root CA

### 1. Create CA Directory Structure
```bash
mkdir -p /etc/ssl/lksn-ca/{private,certs,newcerts,crl}
cd /etc/ssl/lksn-ca
touch index.txt
echo 1000 > serial
echo 1000 > crlnumber
```

### 2. OpenSSL Configuration: /etc/ssl/lksn-ca/openssl.cnf
```ini
[ ca ]
default_ca = CA_default

[ CA_default ]
dir               = /etc/ssl/lksn-ca
certs             = $dir/certs
crl_dir           = $dir/crl
new_certs_dir     = $dir/newcerts
database          = $dir/index.txt
serial            = $dir/serial
RANDFILE          = $dir/private/.rand

private_key       = $dir/private/ca.key
certificate       = $dir/certs/ca.crt

crlnumber         = $dir/crlnumber
crl               = $dir/crl/ca.crl
crl_extensions    = crl_ext
default_crl_days  = 30

default_md        = sha256
preserve          = no
policy            = policy_loose

[ policy_loose ]
countryName             = optional
stateOrProvinceName     = optional
localityName            = optional
organizationName        = optional
organizationalUnitName  = optional
commonName              = supplied
emailAddress            = optional

[ req ]
default_bits        = 2048
distinguished_name  = req_distinguished_name
string_mask         = utf8only
default_md          = sha256
x509_extensions     = v3_ca

[ req_distinguished_name ]
countryName                     = Country Name (2 letter code)
stateOrProvinceName             = State or Province Name
localityName                    = Locality Name
0.organizationName              = Organization Name
organizationalUnitName          = Organizational Unit Name
commonName                      = Common Name
emailAddress                    = Email Address

[ v3_ca ]
subjectKeyIdentifier = hash
authorityKeyIdentifier = keyid:always,issuer
basicConstraints = critical, CA:true
keyUsage = critical, digitalSignature, cRLSign, keyCertSign

[ v3_intermediate_ca ]
subjectKeyIdentifier = hash
authorityKeyIdentifier = keyid:always,issuer
basicConstraints = critical, CA:true, pathlen:0
keyUsage = critical, digitalSignature, cRLSign, keyCertSign

[ server_cert ]
basicConstraints = CA:FALSE
nsCertType = server
nsComment = "OpenSSL Generated Server Certificate"
subjectKeyIdentifier = hash
authorityKeyIdentifier = keyid,issuer:always
keyUsage = critical, digitalSignature, keyEncipherment
extendedKeyUsage = serverAuth

[ client_cert ]
basicConstraints = CA:FALSE
nsCertType = client, email
nsComment = "OpenSSL Generated Client Certificate"
subjectKeyIdentifier = hash
authorityKeyIdentifier = keyid,issuer
keyUsage = critical, nonRepudiation, digitalSignature, keyEncipherment
extendedKeyUsage = clientAuth, emailProtection
```

### 3. Generate Root CA
```bash
# Generate private key
openssl genrsa -aes256 -out /etc/ssl/lksn-ca/private/ca.key 4096
chmod 400 /etc/ssl/lksn-ca/private/ca.key

# Generate root certificate
openssl req -config /etc/ssl/lksn-ca/openssl.cnf \
    -key /etc/ssl/lksn-ca/private/ca.key \
    -new -x509 -days 3650 -sha256 \
    -extensions v3_ca \
    -out /etc/ssl/lksn-ca/certs/ca.crt \
    -subj "/C=ID/ST=Jakarta/L=Jakarta/O=LKSN2025/OU=IT/CN=LKSN2025 Root CA"

chmod 444 /etc/ssl/lksn-ca/certs/ca.crt
```

**Penjelasan:**
- `-aes256` - Encrypt private key dengan password
- `-days 3650` - Valid 10 tahun
- `basicConstraints = CA:TRUE` - Ini adalah CA certificate
- `keyUsage` - CA bisa sign certificates

## ðŸ“ Generate Server Certificates

### Mail Server Certificate
```bash
# 1. Generate private key
openssl genrsa -out /etc/ssl/lksn-ca/private/mail-srv.key 2048

# 2. Generate CSR
openssl req -config /etc/ssl/lksn-ca/openssl.cnf \
    -key /etc/ssl/lksn-ca/private/mail-srv.key \
    -new -sha256 -out /etc/ssl/lksn-ca/certs/mail-srv.csr \
    -subj "/C=ID/ST=Jakarta/O=LKSN2025/CN=mail-srv.lksn2025.id"

# 3. Sign with CA
openssl ca -config /etc/ssl/lksn-ca/openssl.cnf \
    -extensions server_cert -days 365 -notext -md sha256 \
    -in /etc/ssl/lksn-ca/certs/mail-srv.csr \
    -out /etc/ssl/lksn-ca/certs/mail-srv.crt

# 4. Verify
openssl x509 -noout -text -in /etc/ssl/lksn-ca/certs/mail-srv.crt
```

### Web Server Certificate (dengan SAN)
```bash
# Create SAN config
cat > /tmp/web-san.cnf <<EOF
[req]
distinguished_name = req_distinguished_name
req_extensions = v3_req

[req_distinguished_name]

[v3_req]
subjectAltName = @alt_names

[alt_names]
DNS.1 = www.lksn2025.id
DNS.2 = vip.lksn2025.id
DNS.3 = web-01.lksn2025.id
DNS.4 = web-02.lksn2025.id
IP.1 = 172.16.1.100
IP.2 = 172.16.1.21
IP.3 = 172.16.1.22
EOF

# Generate key & CSR
openssl genrsa -out /etc/ssl/lksn-ca/private/web.key 2048
openssl req -new -key /etc/ssl/lksn-ca/private/web.key \
    -out /etc/ssl/lksn-ca/certs/web.csr \
    -subj "/C=ID/ST=Jakarta/O=LKSN2025/CN=www.lksn2025.id" \
    -config /tmp/web-san.cnf

# Sign
openssl ca -config /etc/ssl/lksn-ca/openssl.cnf \
    -extensions server_cert -days 365 -notext -md sha256 \
    -in /etc/ssl/lksn-ca/certs/web.csr \
    -out /etc/ssl/lksn-ca/certs/web.crt \
    -extfile /tmp/web-san.cnf -extensions v3_req
```

### VPN Server Certificate
```bash
openssl genrsa -out /etc/ssl/lksn-ca/private/vpn.key 2048
openssl req -new -key /etc/ssl/lksn-ca/private/vpn.key \
    -out /etc/ssl/lksn-ca/certs/vpn.csr \
    -subj "/C=ID/ST=Jakarta/O=LKSN2025/CN=vpn.lksn2025.id"

openssl ca -config /etc/ssl/lksn-ca/openssl.cnf \
    -extensions server_cert -days 365 -notext -md sha256 \
    -in /etc/ssl/lksn-ca/certs/vpn.csr \
    -out /etc/ssl/lksn-ca/certs/vpn.crt
```

### phpMyAdmin Self-Signed (90 days - Jombang)
```bash
openssl req -x509 -nodes -days 90 \
    -newkey rsa:2048 \
    -keyout /etc/ssl/lksn-ca/private/phpmyadmin.key \
    -out /etc/ssl/lksn-ca/certs/phpmyadmin.crt \
    -subj "/C=ID/ST=Jakarta/O=LKSN2025/CN=phpmyadmin.lksn2025.id"
```

## ðŸ“¤ Distribute CA Certificate

### To All Servers
```bash
# Copy CA cert
scp /etc/ssl/lksn-ca/certs/ca.crt root@<server>:/usr/local/share/ca-certificates/lksn-ca.crt

# On each server
update-ca-certificates

# Verify
openssl verify -CAfile /etc/ssl/certs/ca-certificates.crt /path/to/server.crt
```

## âœ… Validation Checklist

- [ ] **Root CA**
  - [ ] CA private key exists & encrypted
  - [ ] CA certificate valid for 10 years
  - [ ] basicConstraints = CA:TRUE
  
- [ ] **Server Certificates**
  - [ ] mail-srv.crt generated
  - [ ] web.crt with SAN
  - [ ] vpn.crt generated
  - [ ] phpmyadmin.crt (90 days)
  
- [ ] **Distribution**
  - [ ] CA cert installed on all servers
  - [ ] update-ca-certificates run
  - [ ] Certificates verify against CA

## ðŸ“š References

- [OpenSSL CA Guide](https://jamielinux.com/docs/openssl-certificate-authority/)
- [Certificate Extensions](https://www.openssl.org/docs/man1.1.1/man5/x509v3_config.html)
