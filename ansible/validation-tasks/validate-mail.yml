---
# Mail Service Validation Tasks

- name: "ğŸ” CHECK: Postfix Installed"
  command: dpkg -l postfix
  register: postfix_installed
  failed_when: false
  changed_when: false

- name: "âŒ ERROR: Postfix Not Installed"
  debug:
    msg: |
      â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
      âŒ ERROR: Postfix tidak terinstall
      â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
      
      MASALAH:
      Package postfix tidak ditemukan.
      
      PENJELASAN:
      Postfix adalah SMTP server untuk send/receive email.
      Tanpa Postfix, email tidak bisa dikirim atau diterima.
      
      CARA MEMPERBAIKI:
      apt install postfix -y
      # Pilih "Internet Site" saat installation
      # Domain: lksn2025.id
      
      â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
  when: postfix_installed.rc != 0

- name: "ğŸ” CHECK: Dovecot Installed"
  command: dpkg -l dovecot-core
  register: dovecot_installed
  failed_when: false
  changed_when: false

- name: "âŒ ERROR: Dovecot Not Installed"
  debug:
    msg: |
      â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
      âŒ ERROR: Dovecot tidak terinstall
      â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
      
      MASALAH:
      Package dovecot-core tidak ditemukan.
      
      PENJELASAN:
      Dovecot adalah IMAP server untuk retrieve email.
      Tanpa Dovecot, users tidak bisa read email via client.
      
      CARA MEMPERBAIKI:
      apt install dovecot-core dovecot-imapd -y
      
      â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
  when: dovecot_installed.rc != 0

- name: "ğŸ” CHECK: SMTP Port 25 Listening"
  wait_for:
    port: 25
    timeout: 5
  register: smtp_port
  failed_when: false
  changed_when: false

- name: "âŒ ERROR: SMTP Not Listening on Port 25"
  debug:
    msg: |
      â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
      âŒ ERROR: SMTP tidak listening di port 25
      â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
      
      MASALAH:
      Postfix tidak listening pada port 25 (SMTP).
      
      PENJELASAN:
      Port 25 adalah standard SMTP port untuk receive email
      dari external mail servers. Tanpa ini, incoming email
      dari internet tidak bisa diterima.
      
      CARA MEMPERBAIKI:
      1. Check postfix status:
         systemctl status postfix
      
      2. Check logs:
         tail -f /var/log/mail.log
      
      3. Restart postfix:
         systemctl restart postfix
      
      â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
  when: smtp_port.failed

- name: "ğŸ” CHECK: Roundcube Database Connection"
  shell: grep -q "192.168.1.10" /etc/roundcube/config.inc.php
  register: roundcube_db
  failed_when: false
  changed_when: false

- name: "âŒ ERROR: Roundcube Not Pointing to int-srv Database"
  debug:
    msg: |
      â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
      âŒ ERROR: Roundcube database connection salah
      â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
      
      MASALAH:
      Roundcube tidak connect ke database di int-srv.
      
      PENJELASAN:
      Database sekarang centralized di int-srv (192.168.1.10).
      Roundcube harus connect ke sana, bukan localhost.
      
      CARA MEMPERBAIKI:
      Edit /etc/roundcube/config.inc.php:
      
      $config['db_dsnw'] = 'mysql://roundcube:Skills39!@192.168.1.10/roundcube';
      
      â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
  when: roundcube_db.rc != 0
