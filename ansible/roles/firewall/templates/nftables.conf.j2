#!/usr/sbin/nft -f
# nftables Firewall Configuration for fw-srv
# Generated by Ansible

flush ruleset

table ip filter {
    chain input {
        type filter hook input priority 0; policy drop;
        
        # Allow established/related connections
        ct state established,related accept
        
        # Allow loopback
        iifname "lo" accept
        
        # Allow SSH (Management)
        tcp dport 22 accept
        
        # Allow DNS
        tcp dport 53 accept
        udp dport 53 accept
        
        # Allow VPN
        udp dport 1194 accept   # OpenVPN
        udp dport 51820 accept  # WireGuard
        
        # Allow ICMP (ping)
        icmp type echo-request accept
    }
    
    chain forward {
        type filter hook forward priority 0; policy drop;
        
        # Allow established/related
        ct state established,related accept
        
        # Allow LAN to WAN (Internal to Internet)
        iifname "ens19" oifname "ens18" accept
        
        # Allow VPN to LAN/DMZ
        ip saddr 10.10.0.0/24 accept
        
        # Allow Mail (DMZ) to LDAP (INT)
        ip saddr 172.16.1.10 ip daddr 192.168.1.10 tcp dport { 389, 636 } accept
        
        # Allow DMZ to INT DNS
        iifname "ens20" oifname "ens19" tcp dport 53 accept
        iifname "ens20" oifname "ens19" udp dport 53 accept
        
        # Allow ICMP
        icmp type echo-request accept
    }
    
    chain output {
        type filter hook output priority 0; policy accept;
    }
}

table ip nat {
    chain postrouting {
        type nat hook postrouting priority 100;
        
        # Masquerade (SNAT) for outgoing traffic
        oifname "ens18" masquerade
    }
    
    chain prerouting {
        type nat hook prerouting priority -100;
        
        # DNAT for incoming services
        iifname "ens18" tcp dport { 80, 443 } dnat to 172.16.1.100  # Web VIP
        iifname "ens18" tcp dport 25 dnat to 172.16.1.10            # SMTP
        iifname "ens18" tcp dport { 143, 993 } dnat to 172.16.1.10  # IMAP
    }
}
