---
# Mail Role - Main Tasks
# Postfix + Dovecot + Roundcube

- name: "ğŸ“‹ Display Mail Server Configuration Plan"
  debug:
    msg: |
      â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
      ğŸ“§ MAIL SERVER CONFIGURATION
      â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
      
      Server: {{ inventory_hostname }}
      Domain: {{ domain }}
      
      Components:
      1. Postfix (SMTP) - Port 25, 587
      2. Dovecot (IMAP) - Port 143, 993
      3. Roundcube (Webmail) - HTTPS
      4. LDAP Authentication
      5. SSL/TLS Certificates
      
      â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
  when: explain_mode | default(false)
  tags: [explain]

- name: "â³ Wait for APT Lock"
  shell: while fuser /var/lib/dpkg/lock-frontend >/dev/null 2>&1; do sleep 1; done
  changed_when: false
  tags: [packages]

- name: "ğŸ“¦ Install Mail Packages"
  apt:
    name:
      - postfix
      - dovecot-core
      - dovecot-imapd
      - dovecot-ldap
      - apache2
      - php
      - php-mysql
      - php-ldap
      - php-intl
      - php-mbstring
      - roundcube
      - roundcube-plugins
    state: present
    update_cache: yes
  environment:
    DEBIAN_FRONTEND: noninteractive
  tags: [packages]

- name: "âš™ï¸ Configure Postfix Main"
  template:
    src: postfix-main.cf.j2
    dest: /etc/postfix/main.cf
    mode: '0644'
    backup: yes
  notify: restart postfix
  tags: [postfix]

- name: "âš™ï¸ Configure Postfix Master"
  template:
    src: postfix-master.cf.j2
    dest: /etc/postfix/master.cf
    mode: '0644'
    backup: yes
  notify: restart postfix
  tags: [postfix]

- name: "âš™ï¸ Configure Dovecot"
  template:
    src: dovecot.conf.j2
    dest: /etc/dovecot/dovecot.conf
    mode: '0644'
    backup: yes
  notify: restart dovecot
  tags: [dovecot]

- name: "âš™ï¸ Configure Dovecot LDAP Auth"
  template:
    src: dovecot-ldap.conf.j2
    dest: /etc/dovecot/dovecot-ldap.conf
    mode: '0600'
    backup: yes
  notify: restart dovecot
  tags: [dovecot]

- name: "âš™ï¸ Configure Roundcube"
  template:
    src: roundcube-config.inc.php.j2
    dest: /etc/roundcube/config.inc.php
    mode: '0640'
    owner: root
    group: www-data
    backup: yes
  notify: restart apache2
  tags: [roundcube]

- name: "ğŸ”— Enable Apache Modules"
  apache2_module:
    name: "{{ item }}"
    state: present
  loop:
    - ssl
    - rewrite
  notify: restart apache2
  tags: [apache]

- name: "ğŸ“¥ Fetch Mail Certificate from CA Server"
  fetch:
    src: /etc/ssl/lksn-ca/certs/mail-srv.crt
    dest: /tmp/mail.crt
    flat: yes
  delegate_to: "{{ groups['internal'][0] }}"
  tags: [ssl]

- name: "ğŸ“¥ Fetch Mail Private Key from CA Server"
  fetch:
    src: /etc/ssl/lksn-ca/private/mail-srv.key
    dest: /tmp/mail.key
    flat: yes
  delegate_to: "{{ groups['internal'][0] }}"
  tags: [ssl]

- name: "ğŸ“¤ Install Mail Certificate"
  copy:
    src: /tmp/mail.crt
    dest: /etc/ssl/certs/mail.crt
    mode: '0644'
  tags: [ssl]

- name: "ğŸ“¤ Install Mail Private Key"
  copy:
    src: /tmp/mail.key
    dest: /etc/ssl/private/mail.key
    mode: '0600'
  tags: [ssl]

- name: "âš™ï¸ Configure Roundcube VirtualHost"
  template:
    src: roundcube-vhost.conf.j2
    dest: /etc/apache2/sites-available/roundcube.conf
    mode: '0644'
  notify: restart apache2
  tags: [apache]

- name: "ğŸ”— Enable Roundcube Site"
  command: a2ensite roundcube
  args:
    creates: /etc/apache2/sites-enabled/roundcube.conf
  notify: restart apache2
  tags: [apache]

- name: "ğŸš€ Enable and Start Services"
  systemd:
    name: "{{ item }}"
    enabled: yes
    state: started
  loop:
    - postfix
    - dovecot
    - apache2
  tags: [service]
