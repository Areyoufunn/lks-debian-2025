# Dovecot Configuration
# Generated by Ansible
# Compatible with Dovecot 2.4.1+

# REQUIRED: Config version MUST be first (breaking change from 2.3)
dovecot_config_version = 2.4.1
dovecot_storage_version = 2.4

!include_try /usr/share/dovecot/protocols.d/*.protocol

protocols = imap
listen = *

# SSL/TLS
# NOTE: Dovecot 2.4.x renamed ssl_cert/ssl_key directives and removed the '<' file prefix
ssl = yes
ssl_server_cert_file = /etc/ssl/lksn-ca/certs/mail-srv.crt
ssl_server_key_file  = /etc/ssl/lksn-ca/private/mail-srv.key
# ssl_client_ca_file = /etc/ssl/lksn-ca/certs/ca.crt
# NOTE: ssl_ca_file does not exist in Dovecot 2.4 â€” use ssl_client_ca_file only
# if server needs to verify CLIENT certificates (mutual TLS). Not needed for basic IMAP SSL.

# Authentication
auth_mechanisms = plain login
# NOTE: disable_plaintext_auth removed in Dovecot 2.4, replaced by auth_allow_cleartext
auth_allow_cleartext = no

# LDAP authentication
# NOTE: Dovecot 2.4 uses ldap_uris (not ldap_url or hosts)
# auth_bind=yes uses LDAP bind for auth (most reliable with OpenLDAP)
passdb ldap {
  ldap_uris = ldap://192.168.1.10
  dn = cn=admin,dc=lksn2025,dc=id
  dnpass = Skills39!
  ldap_version = 3
  base = ou=People,dc=lksn2025,dc=id
  scope = subtree
  auth_bind = yes
  auth_bind_userdn = uid=%{user},ou=People,dc=lksn2025,dc=id
}

userdb ldap {
  ldap_uris = ldap://192.168.1.10
  dn = cn=admin,dc=lksn2025,dc=id
  dnpass = Skills39!
  ldap_version = 3
  base = ou=People,dc=lksn2025,dc=id
  scope = subtree
  user_filter = (&(objectClass=posixAccount)(uid=%{user}))
  user_attrs = homeDirectory=home,uidNumber=uid,gidNumber=gid
}

# Mail location
mail_location = maildir:~/Maildir

# Postfix SASL
service auth {
  unix_listener /var/spool/postfix/private/auth {
    mode = 0660
    user = postfix
    group = postfix
  }
}
