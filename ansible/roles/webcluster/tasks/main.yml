---
# Web Cluster Role - Main Tasks
# Keepalived + HAProxy + Nginx

- name: "ğŸ“‹ Display Web Cluster Configuration Plan"
  debug:
    msg: |
      â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
      ğŸŒ WEB CLUSTER CONFIGURATION
      â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
      
      Server: {{ inventory_hostname }}
      Role: {{ keepalived_state }}
      Priority: {{ keepalived_priority }}
      VIP: {{ vip }}
      
      Tasks:
      1. Install Keepalived (HA/Failover)
      2. Install HAProxy (Load Balancer)
      3. Install Nginx (Web Server)
      4. Configure VIP failover
      5. Configure load balancing
      
      â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
  when: explain_mode | default(false)
  tags: [explain]

- name: "ğŸ“¦ Install Packages"
  apt:
    name:
      - keepalived
      - haproxy
      - nginx
    state: present
    update_cache: yes
  tags: [packages]

- name: "âš™ï¸ Configure Keepalived"
  template:
    src: keepalived.conf.j2
    dest: /etc/keepalived/keepalived.conf
    mode: '0644'
    backup: yes
  notify: restart keepalived
  tags: [keepalived]

- name: "âš™ï¸ Configure HAProxy"
  template:
    src: haproxy.cfg.j2
    dest: /etc/haproxy/haproxy.cfg
    mode: '0644'
    backup: yes
  notify: restart haproxy
  tags: [haproxy]

- name: "âš™ï¸ Configure Nginx"
  template:
    src: nginx-default.j2
    dest: /etc/nginx/sites-available/default
    mode: '0644'
    backup: yes
  notify: restart nginx
  tags: [nginx]

- name: "ğŸ“ Create Web Root"
  file:
    path: /var/www/html
    state: directory
    owner: www-data
    group: www-data
    mode: '0755'
  tags: [nginx]

- name: "ğŸ“„ Create Index Page"
  copy:
    content: "<h1>Hello from {{ inventory_hostname }}</h1>"
    dest: /var/www/html/index.html
    owner: www-data
    group: www-data
    mode: '0644'
  tags: [nginx]

- name: "ğŸ”’ Create Protected Directory"
  file:
    path: /var/www/html/data/file
    state: directory
    owner: www-data
    group: www-data
    mode: '0755'
  tags: [nginx]

- name: "ğŸ“¥ Fetch Web Certificate from CA Server"
  fetch:
    src: /etc/ssl/lksn-ca/certs/web.crt
    dest: /tmp/www.crt
    flat: yes
  delegate_to: "{{ groups['internal'][0] }}"
  tags: [ssl]

- name: "ğŸ“¥ Fetch Web Private Key from CA Server"
  fetch:
    src: /etc/ssl/lksn-ca/private/web.key
    dest: /tmp/www.key
    flat: yes
  delegate_to: "{{ groups['internal'][0] }}"
  tags: [ssl]

- name: "ğŸ“¤ Install Web Certificate"
  copy:
    src: /tmp/www.crt
    dest: /etc/ssl/certs/www.crt
    mode: '0644'
  tags: [ssl]

- name: "ğŸ“¤ Install Web Private Key"
  copy:
    src: /tmp/www.key
    dest: /etc/ssl/private/www.key
    mode: '0600'
  tags: [ssl]

- name: "ğŸ”‘ Create htpasswd"
  command: htpasswd -bc /etc/nginx/.htpasswd rahasia Skills39
  args:
    creates: /etc/nginx/.htpasswd
  tags: [nginx]

- name: "ğŸš€ Enable and Start Services"
  systemd:
    name: "{{ item }}"
    enabled: yes
    state: started
  loop:
    - keepalived
    - haproxy
    - nginx
  tags: [service]
